## 1.原子操作的实现原理

### 1.1什么是原子操作

原子操作(atomic operation)意为不可中断的一个或者一系列操作。

### 1.2相关的术语

| 术语         | 英文                   | 解释                                                         |
| ------------ | ---------------------- | ------------------------------------------------------------ |
|              | Cache line             | 缓存操作的最小的单位                                         |
| 比较并交换   | Compare and Swap       | CAS操作，旧值，新值，操作的时候比较旧值没有发生变化就交换成新的值，否则不交换 |
| CPU流水线    | CPU pipeline           | 在CPU中有5-6个不同功能的电路单元组成一条指令处理流水线，然后将一条X86指令分成5-6步后再由这些单元分别执行，在一个CPU时钟周期内完成一条指令，提高CPU运算速度 |
| 内存顺序冲突 | Memory order violation | 一般是由假共享引起的，指多个CPU同时修改一个缓存行的不同部分而引起的一个CPU的操作无效，当出现这个内存顺序冲突时，CPU必须清空流水线 |

### 1.3CPU实现原子性的方法

1）使用总线锁保证原子性
所谓的总线锁就是使用处理器提供的一个LOCK#信号，一个CPU在从缓存中读取变量的值之后，向总线输出该信号，其他的CPU不能够操作缓存了该共享变量内存地址的缓存并被阻塞住，原处理器可以独占共享内存

2）使用缓存锁保证原子性
总线锁的开销较大，不仅不能操作共享变量的内存，而且也不能操作其他的内存地址的数据。
频繁使用的内存会缓存在处理器的L1、 L2和L3高速缓存里,那么原子操作就可以直接在处理器内部缓存中进行,并不需要声明总线锁,在Pentium6和目前的处理器中可以使用“缓存锁定”的方式来实现复杂的原子性。
所谓“缓存锁定”是指内存区域如果被缓存在处理器的缓存行中,并且在Lock操作期间被锁定,那么当它执行锁操作回写到内存时,处理器不在总线上声言LOCK#信号,而是修改内部的内存地址,并允许它的缓存一致性机制来保证操作的原子性,因为缓存一致性机制会阻止同时修改由两个以上处理器缓存的内存区域数据,当其他处理器回写已被锁定的缓存行的数据时,会使缓存行无效